FROM maven:3.9.6-eclipse-temurin-21 AS build
WORKDIR /app
COPY . .
RUN mvn clean package -DskipTests

# Package stage
# FROM eclipse-temurin:21-jre-jammy

FROM gocv/opencv:4.9.0-ubuntu-22.04

RUN apt-get update && apt-get install -y --no-install-recommends \
    openjdk-21-jre-headless \ # Or whichever Java 21 JRE package is available
    && rm -rf /var/lib/apt/lists/*

# Set the desired OpenCV version
#ARG OPENCV_VERSION=4.9.0

WORKDIR /app

ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV JAVA_OPTS="-Djava.library.path=/usr/local/share/java/opencv4" # Adjust path as needed


#RUN apt-get update && apt-get install -y --no-install-recommends \
#    build-essential \
#    cmake \
#    git \
#    unzip \
#    pkg-config \
#    libjpeg-dev \
#    libpng-dev \
#    libtiff-dev \
#    libavcodec-dev \
#    libavformat-dev \
#    libswscale-dev \
#    libv4l-dev \
#    libxvidcore-dev \
#    libx264-dev \
#    libgtk2.0-dev \
#    libatlas-base-dev \
#    gfortran \
#    && rm -rf /var/lib/apt/lists/*

# Download OpenCV source
#RUN wget -O opencv.zip https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.zip && \
#    unzip opencv.zip && \
#    rm opencv.zip && \
#    mv opencv-${OPENCV_VERSION} opencv

#WORKDIR /app/opencv/build
#RUN cmake -D CMAKE_BUILD_TYPE=Release \
#          -D CMAKE_INSTALL_PREFIX=/usr/local \
#          -D BUILD_PYTHON_SUPPORT=OFF \
#          -D BUILD_JAVA=ON \
#          -D INSTALL_C_EXAMPLES=OFF \
#          -D INSTALL_PYTHON_EXAMPLES=OFF \
#          -D WITH_QT=OFF \
#          -D WITH_GTK=ON \
#          -D WITH_IPP=ON \
#          -D WITH_TBB=ON \
#          -D BUILD_EXAMPLES=OFF \
#          -D BUILD_TESTS=OFF \
#          -D OPENCV_GENERATE_PKGCONFIG=ON \
#          -D WITH_FFMPEG=ON \
#          -D WITH_LIBV4L=ON \
#          -D WITH_OPENGL=OFF \
#          -D WITH_GDAL=OFF \
#          -D WITH_LAPACK=ON \
#          -D WITH_EIGEN=ON \
#          # -D OPENCV_EXTRA_MODULES_PATH=/app/opencv_contrib/modules \ Uncomment if using contrib
#          .. && \
#    make -j$(nproc) && \
#    make install && \
#    ldconfig


# Install OpenCV dependencies for Linux (example, may vary)
#RUN apt-get update && apt-get install -y \
#    libopencv-dev \
#    libatlas-base-dev \
#    libgtk2.0-dev \
#    && rm -rf /var/lib/apt/lists/*

COPY --from=build /app/target/*.jar /app/facedec.jar

ENV PORT=8080
EXPOSE 8080
ENTRYPOINT ["java","-jar","facedec.jar"]